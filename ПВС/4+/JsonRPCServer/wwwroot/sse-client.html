<!DOCTYPE html>
<html>
<head>
    <title>SSE Client - JSON-RPC Events</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .client {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 10px;
        }

        .events {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 10px;
        }

        .event {
            margin: 5px 0;
            padding: 5px;
            background: #f5f5f5;
        }

        .success {
            border-left: 4px solid green;
        }

        .error {
            border-left: 4px solid red;
        }
    </style>
</head>
<body>
    <h1>SSE Client for JSON-RPC Events</h1>

    <div class="client">
        <h3>Client <span id="clientId"></span></h3>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
        <div>Status: <span id="status">Disconnected</span></div>
        <div>Subscribers: <span id="subscriberCount">0</span></div>

        <h4>Events:</h4>
        <div id="events" class="events"></div>
    </div>

    <script>
        let eventSource = null;
        const clientId = Math.random().toString(36).substr(2, 9);
        document.getElementById('clientId').textContent = clientId;

        function connect() {
            if (eventSource) return;

            eventSource = new EventSource('/api/events');

            eventSource.onopen = function() {
                document.getElementById('status').textContent = 'Connected';
                updateSubscriberCount();
            };

            eventSource.onmessage = function(event) {
                addEvent('ping', event.data, 'info');
            };

            eventSource.addEventListener('SUM', function(event) {
                const data = JSON.parse(event.data);
                addEvent('SUM', data, 'success');
            });

            eventSource.addEventListener('SUB', function(event) {
                const data = JSON.parse(event.data);
                addEvent('SUB', data, 'success');
            });

            eventSource.addEventListener('MUL', function(event) {
                const data = JSON.parse(event.data);
                addEvent('MUL', data, 'success');
            });

            eventSource.addEventListener('DIV', function(event) {
                const data = JSON.parse(event.data);
                const className = data.error ? 'error' : 'success';
                addEvent('DIV', data, className);
            });

            eventSource.addEventListener('FACT', function(event) {
                const data = JSON.parse(event.data);
                const className = data.error ? 'error' : 'success';
                addEvent('FACT', data, className);
            });

            eventSource.onerror = function() {
                document.getElementById('status').textContent = 'Error';
                setTimeout(connect, 5000);
            };
        }

        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                document.getElementById('status').textContent = 'Disconnected';
                updateSubscriberCount();
            }
        }

        function addEvent(type, data, className) {
            const eventsDiv = document.getElementById('events');
            const eventDiv = document.createElement('div');
            eventDiv.className = `event ${className}`;
            eventDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> [${type}]: ${JSON.stringify(data)}`;
            eventsDiv.appendChild(eventDiv);
            eventsDiv.scrollTop = eventsDiv.scrollHeight;
        }

        async function updateSubscriberCount() {
            try {
                const response = await fetch('/api/events/subscribers');
                const data = await response.json();
                document.getElementById('subscriberCount').textContent = data.subscribers;
            } catch (error) {
                console.error('Error fetching subscriber count:', error);
            }
        }

        setInterval(updateSubscriberCount, 5000);
        connect();
    </script>
</body>
</html>